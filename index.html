<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTC USDT | Monitor</title>
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            height: 100vh;
            overflow: hidden;
            background: #0f1115;
            color: #eaecef;
            font-family: Arial, sans-serif;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 8px;
            height: 100vh;
            padding: 8px;
        }

        .chart-container { 
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .chart { 
            background: #131722; 
            border-radius: 8px; 
            flex-grow: 1;
            overflow: hidden; 
        }
        #tradingview_btc { height: 100%; }

        .trades-box {
            background: #131722;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .price-header { text-align: center; font-size: 24px; font-weight: bold; padding: 10px; border-bottom: 1px solid #2a2e39; flex-shrink: 0; }
        
        #volumeContainer { flex-shrink: 0; }
        .volume-box { padding: 5px 8px; border-bottom: 1px solid #2a2e39; }
        .volume-title { font-size: 10px; margin-bottom: 3px; text-align:center; color: #848e9c; text-transform: uppercase; }
        .volume-bar { display: flex; height: 8px; border-radius: 4px; overflow: hidden; background: #1e222d; }
        .volume-buy { background: #0ecb81; transition: width 0.3s ease; }
        .volume-sell { background: #f6465d; transition: width 0.3s ease; }
        .volume-labels { display: flex; justify-content: space-between; font-size: 9px; margin-top: 2px; }

        .filters { display: flex; justify-content: space-around; padding: 5px; background: #1e222d; flex-shrink: 0; }
        .filters button { background:transparent; color:#848e9c; border:1px solid #474d57; padding:4px 10px; border-radius:4px; cursor:pointer; font-size:11px; }
        .filters button.active { background:#474d57; color:#fff; }

        /* LISTA COM SCROLL */
        #trades { 
            list-style: none; 
            margin: 0; 
            padding: 0; 
            overflow-y: scroll; /* Scroll sempre ativo */
            flex-grow: 1; /* Ocupa o resto da altura */
            font-family: 'Courier New', monospace;
            -webkit-overflow-scrolling: touch;
        }

        /* EstilizaÃ§Ã£o da barra de rolagem */
        #trades::-webkit-scrollbar { width: 6px; }
        #trades::-webkit-scrollbar-track { background: #131722; }
        #trades::-webkit-scrollbar-thumb { background: #2a2e39; border-radius: 10px; }

        #trades li { 
            padding: 6px 8px; 
            border-bottom: 1px solid #1e222d; 
            display: grid; 
            grid-template-columns: 1fr 1.2fr 1.2fr 1.5fr; 
            font-size: 12px; 
            text-align: right;
        }
        #trades li span:first-child { text-align: left; font-weight: bold; }
        
        .buy { color: #0ecb81; }
        .sell { color: #f6465d; }
        .whale { background: rgba(255, 255, 255, 0.05); font-weight: bold; border-left: 4px solid #0ecb81; }
        .sell.whale { border-left: 4px solid #f6465d; }

        .whale-popup-container { position: fixed; top: 10px; right: 10px; display: flex; flex-direction: column; gap: 6px; z-index: 999; }
        .whale-popup { color: #fff; padding: 12px; border-radius: 6px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.6); animation: slide 0.3s ease; min-width: 220px; }
        @keyframes slide { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .popup-buy { background: #0ecb81; color: #000; }
        .popup-sell { background: #f6465d; color: #fff; }

        @media (max-width: 768px) {
            .dashboard { grid-template-columns: 1fr; grid-template-rows: 40vh 60vh; padding: 4px; gap: 4px; }
            .chart-container { height: 40vh; }
            .trades-box { height: 60vh; } /* Altura definida para o scroll funcionar */
            .price-header { font-size: 18px; padding: 6px; }
            #trades li { font-size: 10px; padding: 5px 2px; }
        }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="chart-container">
        <div class="chart">
            <div id="tradingview_btc"></div>
        </div>
    </div>

    <div class="trades-box">
        <div class="price-header" id="btcPrice">0.00</div>
        <div id="volumeContainer"></div>
        <div class="filters">
            <button data-filter="all" class="active">Todos</button>
            <button data-filter="buy">Compras</button>
            <button data-filter="sell">Vendas</button>
        </div>
        <ul id="trades"></ul>
        <div class="whale-popup-container" id="whalePopupContainer"></div>
    </div>
</div>

<script src="https://s3.tradingview.com/tv.js"></script>
<script>
new TradingView.widget({
    width: "100%", height: "100%", symbol: "BINANCE:BTCUSDT",
    interval: "D", timezone: "America/Sao_Paulo", theme: "dark",
    style: "1", locale: "pt_BR", container_id: "tradingview_btc",
    hide_side_toolbar: true, save_image: false
});

const sndBuy = new Audio('https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3');
const sndSell = new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3');

document.addEventListener('click', () => {
    sndBuy.play().then(() => { sndBuy.pause(); sndBuy.currentTime = 0; });
    sndSell.play().then(() => { sndSell.pause(); sndSell.currentTime = 0; });
}, { once: true });

const volumes = {};
const timeframes = [
    {l:"1m", m:60000}, 
    {l:"10m", m:600000}, 
    {l:"1h", m:3600000}
];

const volCont = document.getElementById("volumeContainer");

timeframes.forEach(tf => {
    volumes[tf.l] = { b: 0, s: 0 };
    volCont.innerHTML += `
        <div class="volume-box">
            <div class="volume-title">PressÃ£o ${tf.l}</div>
            <div class="volume-bar">
                <div id="b-${tf.l}" class="volume-buy" style="width:50%"></div>
                <div id="s-${tf.l}" class="volume-sell" style="width:50%"></div>
            </div>
            <div class="volume-labels">
                <span id="bt-${tf.l}">C: 50%</span>
                <span id="st-${tf.l}">V: 50%</span>
            </div>
        </div>`;
    setInterval(() => { volumes[tf.l] = {b:0, s:0}; updateBar(tf.l); }, tf.m);
});

let currentFilter = 'all';
document.querySelectorAll('.filters button').forEach(btn => {
    btn.onclick = () => {
        document.querySelectorAll('.filters button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        applyFilter();
    };
});

const socket = new WebSocket("wss://stream.binance.com:9443/ws/btcusdt@trade");
let lastP = 0;

socket.onmessage = (e) => {
    const d = JSON.parse(e.data);
    const p = parseFloat(d.p);
    const q = parseFloat(d.q);
    const isS = d.m;
    const totalUSDT = p * q;
    const priceFormatted = p.toLocaleString('en-US', { minimumFractionDigits: 2 });

    document.title = `â‚¿ ${priceFormatted}`;
    const elP = document.getElementById("btcPrice");
    elP.textContent = priceFormatted;
    elP.style.color = p >= lastP ? '#0ecb81' : '#f6465d';
    lastP = p;

    timeframes.forEach(tf => {
        isS ? volumes[tf.l].s += totalUSDT : volumes[tf.l].b += totalUSDT;
        updateBar(tf.l);
    });

    if (q >= 1) { 
        playSnd(isS);
        showPop(p, q, isS, totalUSDT);
    }
    addLi(p, q, isS, totalUSDT);
};

function updateBar(tf) {
    const total = volumes[tf].b + volumes[tf].s || 1;
    const bp = (volumes[tf].b / total) * 100;
    document.getElementById(`b-${tf}`).style.width = bp + "%";
    document.getElementById(`s-${tf}`).style.width = (100 - bp) + "%";
    document.getElementById(`bt-${tf}`).textContent = `C: ${bp.toFixed(1)}%`;
    document.getElementById(`st-${tf}`).textContent = `V: ${(100 - bp).toFixed(1)}%`;
}

function addLi(p, q, isS, totalUSDT) {
    const list = document.getElementById("trades");
    const li = document.createElement("li");
    li.className = isS ? "sell" : "buy";
    if(q >= 1) li.classList.add("whale");
    
    const totalFormatted = totalUSDT.toLocaleString('en-US', { maximumFractionDigits: 0 });
    
    li.innerHTML = `
        <span>${isS?'VENDA':'COMPRA'}</span> 
        <span>${p.toFixed(1)}</span> 
        <span>${q.toFixed(3)}</span> 
        <span>$${totalFormatted}</span>`;
    
    list.prepend(li);
    // Limite de 50 resultados
    if(list.children.length > 50) list.removeChild(list.lastChild);
    applyFilter();
}

function applyFilter() {
    document.querySelectorAll('#trades li').forEach(li => {
        if(currentFilter === 'all') li.style.display = 'grid';
        else li.style.display = li.classList.contains(currentFilter) ? 'grid' : 'none';
    });
}

function showPop(p, q, isS, totalUSDT) {
    const c = document.getElementById("whalePopupContainer");
    const pop = document.createElement("div");
    pop.className = `whale-popup ${isS ? 'popup-sell' : 'popup-buy'}`;
    const totalFormatted = totalUSDT.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
    
    pop.innerHTML = `ðŸš¨ BALEIA ${isS ? 'VENDEU' : 'COMPROU'}<br>${q.toFixed(3)} BTC (${totalFormatted})`;
    c.prepend(pop);
    setTimeout(() => { pop.style.opacity = '0'; setTimeout(()=>pop.remove(), 500); }, 4000);
}

function playSnd(isS) {
    const s = isS ? sndSell : sndBuy;
    s.currentTime = 0;
    s.play().catch(() => {}); 
}
</script>
</body>
</html>
